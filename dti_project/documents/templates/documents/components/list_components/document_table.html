{% load custom_filters %}

<form method="POST" action="{% url 'approve-documents' %}" id="documents-table-form">
    {% csrf_token %}
    <table class="documents-table">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" id="select-all-checkbox">
                </th>
                <th>
                    Name
                    <button id="sort-by-name-btn" type="button" class="sort-btn" data-sort="name">
                        <i class="fa-solid {% if sort_by == 'name' %}{% if order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %}"></i>
                    </button>
                </th>
                <th>Document Type</th>
                <th>User</th>
                <th>Status</th>
                <th>
                    Date Created
                    <button id="sort-by-date-btn" type="button" class="sort-btn" data-sort="date">
                        <i class="fa-solid {% if sort_by == 'date' or not sort_by %}{% if order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}{% else %}fa-sort{% endif %}"></i>
                    </button>
                </th>
                <th>Payment</th>
                {% if request.user.role != 'business_owner' %}
                    <th>Order of Payment</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for document in documents %}
                <tr class="document-value-row" data-href="{{ document.get_absolute_url }}">
                    <td>
                        <input type="checkbox" name="documents" value="{{ document.model_name }}:{{ document.id }}">
                    </td>
                    <td>{{ document }}</td>
                    <td>{{ document.model_verbose_name|titlecase }}</td>
                    <td>
                        {% if document.user == request.user %}
                            You
                        {% else %}
                            {{ document.user }}
                        {% endif %}
                    </td>
                    <!-- Status column -->
                    <td>
                        {# Status badge #}
                        {% if document.status == "draft" %}
                            <span class="status-badge status-badge-draft">Draft</span>
                        {% elif document.status in "submitted submitted_paid submitted_unpaid" %}
                            <span class="status-badge status-badge-submitted">Submitted</span>
                        {% elif document.status == "approved" %}
                            <span class="status-badge status-badge-approved">Approved</span>
                        {% endif %}

                        {# Row-level approve button for submitted documents #}
                        {% if request.user.role != 'business_owner' and document.status in "submitted submitted_paid submitted_unpaid" %}
                            <form method="POST" action="{% url 'approve-documents' %}" style="display:inline; margin-left: 8px;">
                                {% csrf_token %}
                                <input type="hidden" name="documents" value="{{ document.model_name }}:{{ document.id }}">
                                <button type="submit" class="approve-btn">Approve</button>
                            </form>
                        {% endif %}
                    </td>


                    <td>
                        {% if document.date %}
                            {{ document.date }}
                        {% else %}
                            {{ document.date_filed }}
                        {% endif %}
                    </td>

                    <!-- Payment column -->
                    <td>
                        {% if document.model_verbose_name == 'Sales Promotion Permit Application' %}
                            {% with document.order_of_payment as oop %}
                                {% if not oop %}
                                    <span class="payment-badge payment-badge-warning">Pending OOP</span>

                                {% else %}
                                    {% if request.user.role == 'admin' or request.user.role == 'collection_agent' %}
                                            {% if oop.payment_status == 'awaiting' %}
                                                <span class="payment-badge payment-badge-secondary">Awaiting Payment</span>
                                            {% elif oop.payment_status == 'paid' %}
                                                <a href="{% url 'verify-payment' oop.pk %}" class="payment-btn payment-btn-blue">Verify Payment</a>
                                            {% elif oop.payment_status == 'verified' %}
                                                <div class="payment-status-vertical">
                                                    <span class="payment-badge payment-badge-success">Paid & Verified</span>
                                                    
                                                    <a href="{% url 'download-receipt' oop.pk %}" target="_blank" class="payment-btn payment-btn-blue" onclick="event.stopPropagation();">Download Receipt</a>
                                                </div>
                                            {% else %}
                                                <span class="payment-badge payment-badge-light">Unknown</span>
                                            {% endif %}

                                    {% else %}
                                        {% if oop.payment_status == 'awaiting' %}
                                            <a href="{% url 'payment-page' oop.pk %}" class="payment-btn payment-btn-green">Pay</a>
                                        {% elif oop.payment_status == 'paid' %}
                                            <span class="payment-badge payment-badge-info">Pending Verification</span>
                                        {% elif oop.payment_status == 'verified' %}
                                            <div class="payment-status-horizontal">
                                                <span class="payment-badge payment-badge-success">Paid</span>
                                                <a href="{% url 'download-receipt' oop.pk %}" class="payment-btn payment-btn-blue">Download Receipt</a>
                                            </div>
                                        {% else %}
                                            <span class="payment-badge payment-badge-light">Unknown</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                        {% else %}
                        {% endif %}
                    </td>

                    <!-- Order of Payment column -->
                    <td>
                        {% if request.user.role != 'business_owner' %}
                            {% if document.model_verbose_name == 'Sales Promotion Permit Application' %}
                                {% if document.status != 'approved' %}
                                    <span class="oop-badge oop-badge-warning">Pending for Approval</span>
                                {% else %}
                                    {% with document.order_of_payment as oop %}
                                        {% if oop %}
                                            <a href="{% url 'view-oop' oop.pk %}" target="_blank" class="oop-btn oop-view" onclick="event.stopPropagation();">Download OOP</a>
                                        {% else %}
                                            <a href="{% url 'create-order-of-payment' %}?sppa={{ document.pk }}" class="oop-btn oop-create" onclick="event.stopPropagation();">Create OOP</a>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            {% else %}
                                <span class="text-muted"></span>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</form>