{% extends "dashboard/layout.html" %}
{% load static %}

{% block title %}Edit Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/css/profile_edit.css' %}">
{% endblock %}

{% block body %}
<div class="profile-wrapper">
    <div class="profile-card">

        <!-- Profile Header Container -->
        <div class="profile-header-container">
            <!-- Banner -->
            <div class="profile-banner"></div>

            <!-- Header Content: Picture + Info -->
            <div class="profile-header-content">
                <!-- Profile Picture -->
                <div class="profile-picture-wrapper">
                    {% if profile.profile_picture %}
                    <img id="profile-picture-preview" src="{{ profile.profile_picture.url }}"
                        alt="{{ profile.username }}" class="profile-picture">
                    {% else %}
                    <div id="profile-avatar-preview" class="profile-avatar">
                        {{ profile.get_full_name|slice:":1" }}
                    </div>
                    {% endif %}
                    <!-- Optional Overlay Input -->
                    <label for="id_profile_picture" class="profile-picture-input">
                        <i class="fas fa-camera"></i>
                    </label>
                </div>

                <!-- Profile Info -->
                <div class="profile-info-container">
                    <h1 class="profile-name">{{ profile.get_full_name }}</h1>
                    <p class="profile-username">@{{ profile.username }}</p>
                    <span class="role-badge role-{{ profile.role }}">
                        {{ profile.role|title }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <div class="profile-body">
            <h2>Edit Information</h2>
            <form id="profile-edit-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="form-group">
                    <label for="id_first_name">First Name</label>
                    <input type="text" name="first_name" id="id_first_name" class="form-control"
                        value="{{ profile.first_name }}">
                </div>

                <div class="form-group">
                    <label for="id_last_name">Last Name</label>
                    <input type="text" name="last_name" id="id_last_name" class="form-control"
                        value="{{ profile.last_name }}">
                </div>

                <div class="form-group">
                    <label for="id_email">Email</label>
                    <input type="email" name="email" id="id_email" class="form-control" value="{{ profile.email }}">
                </div>

                <div class="form-group">
                    <label for="id_default_address">Default Address</label>
                    <input type="text" name="default_address" id="id_default_address" class="form-control"
                        value="{{ profile.default_address|default_if_none:'' }}">
                </div>

                <div class="form-group">
                    <label for="id_default_phone">Default Phone</label>
                    <input type="text" name="default_phone" id="id_default_phone"
                        value="{{ form.default_phone.value|default_if_none:'' }}" required maxlength="11"
                        pattern="\d{11}" title="Phone number must be exactly 11 digits"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,11);">
                </div>

                <div class="form-group">
                    <label for="id_birthday">Birthday</label>
                    <input type="date" name="birthday" id="id_birthday" class="form-control"
                        value="{{ profile.birthday|date:'Y-m-d' }}" max="{{ today|date:'Y-m-d' }}" required>
                </div>


                <div class="form-group" style="display:none;">
                    <input type="file" name="profile_picture" id="id_profile_picture" class="form-control"
                        accept="image/*">
                </div>

                <div class="profile-actions">
                    <!-- Cancel goes back to settings -->
                    <a href="{% url 'settings' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </a>

                    <!-- Save Changes submits the form as before -->
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('id_profile_picture');
        const imgPreview = document.getElementById('profile-picture-preview');
        const avatarPreview = document.getElementById('profile-avatar-preview');

        fileInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    if (imgPreview) {
                        imgPreview.src = e.target.result;
                    } else if (avatarPreview) {
                        // Replace avatar div with an img element
                        const img = document.createElement('img');
                        img.id = 'profile-picture-preview';
                        img.className = 'profile-picture';
                        img.src = e.target.result;
                        avatarPreview.replaceWith(img);
                    }
                };

                reader.readAsDataURL(file);
            }
        });
    });
</script>
{% endblock %}
{% block extra_js %}
<script src="{% static 'users/js/profile_edit.js' %}"></script>
{% endblock %}