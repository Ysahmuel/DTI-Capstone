{% extends 'users/layout.html' %}

{% block title %} Reset Password {% endblock %}

{% block body %}
<div class="glass-layer">
    <div class="authentication-form-container">

        <!-- Password reset form -->
        <form method="post" id="reset-password-form" class="authentication-form" action="{% url 'reset_password' %}">
            <img src="/media/media/dti-logo.png" alt="DTI Logo Image" id="dti-logo">

            {% csrf_token %}
            <header>
                <h1>Reset Your Password</h1>
                <h3>Enter your new password below to regain access to your account.</h3>
            </header>

            <div class="form-scroll">
                <div class="form-group">
                    <label for="id_password">New Password</label>
                    <input type="password" name="password" id="id_password" placeholder="Enter new password" required>
                </div>

                <div class="form-group">
                    <label for="id_password2">Confirm Password</label>
                    <input type="password" name="confirm_password" id="id_password2" placeholder="Re-enter new password" required>
                </div>
            </div>

            <button type="submit">Reset Password</button>

            <div class="message-feedback-container">
                <p>Remembered your password? <a href="{% url 'sign-in' %}">Sign in instead</a></p>
                {% if error %}
                    <p class="error-message">{{ error }}</p>
                {% endif %}
            </div>
        </form>

        <!-- Right-side graphics panel (same as register/forgot password) -->
        <div class="graphics-panel">
            <header>
                <h1>Reset your password securely.</h1>
                <h3>Enter your new password to protect your account and regain full access.</h3>
            </header>
            <div class="bar-graph-preview">
                <div class="wrapper">
                    <h4>Security Center</h4>
                    <div class="actions">
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <ul>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                </ul>
            </div>
        </div>

    </div>
</div>

<script>
document.getElementById('reset-password-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    fetch(form.action || window.location.href, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.redirect) {
            window.location.href = data.redirect;
        } else if (data.message) {
            let errorEl = document.querySelector('.error-message');
            if (!errorEl) {
                errorEl = document.createElement('p');
                errorEl.className = 'error-message';
                errorEl.style.color = 'red';
                form.querySelector('.message-feedback-container').appendChild(errorEl);
            }
            errorEl.textContent = data.message;
        }
    })
    .catch(err => console.error(err));
});
</script>
{% endblock %}
