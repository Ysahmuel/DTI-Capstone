{% extends 'users/layout.html' %}

{% block title %} Forgot Password {% endblock %}

{% block body %}
<div class="glass-layer">
    <div class="authentication-form-container">

        <!-- Step 1: Enter email -->
        <form action="{% url 'forgot_password' %}" class="authentication-form" id="forgot-password-form" method="post">
            <img src="/media/media/dti-logo.png" alt="DTI Logo Image" id="dti-logo">
            {% csrf_token %}
            <header>
                <h1>Forgot Your Password?</h1>
                <h3>Enter your registered email address to receive a password reset link.</h3>
            </header>

            <div class="form-scroll">
                <div class="form-group">
                    <label for="id_email">Email Address</label>
                    <input type="email" name="email" id="id_email" required
                        value="{{ form.email.value|default_if_none:'' }}"
                        hx-post="{% url 'check-email-exists' %}"
                        hx-trigger="change delay:250ms"
                        hx-target="#email-check-result"
                        hx-swap="innerHTML">
                </div>
            </div>

            <button type="submit">Send Reset Link</button>

            <div class="message-feedback-container">
                <p>Remember your password? <a href="{% url 'sign-in' %}">Sign in instead</a></p>
                <div id="email-check-result" class="email-check-message"></div>

                {% if messages %}
                    <div class="feedback-messages">
                        {% for message in messages %}
                            <p class="{{ message.tags }}">{{ message }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </form>

        <!-- Step 2: Verification modal -->
        {% include 'users/verification_modal.html' %}

        <div class="graphics-panel">
            <header>
                <h1>Reset your password securely.</h1>
                <h3>Weâ€™ll send you an email with instructions to create a new one.</h3>
            </header>

            <div class="bar-graph-preview">
                <div class="wrapper">
                    <h4>Security</h4>
                    <div class="actions">
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <ul>
                    <li></li><li></li><li></li><li></li><li></li><li></li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% if verification_sent %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.querySelector('.verification-container');
    if (modal) {
        modal.style.display = 'block'; // show modal
    }

    // Set form action for verification
    const verifyForm = modal.querySelector('form');
    if (verifyForm) {
        verifyForm.action = "{% url 'verify-user' %}";
    }

    // Set resend link
    const resendLink = modal.querySelector('.resend-code');
    if (resendLink) {
        resendLink.href = "{% url 'resend-code' %}";
    }
});
</script>
{% endif %}

{% endblock %}
